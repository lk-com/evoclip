# EvoClip 环境配置说明

## 1. 文档范围

本文档详细说明 EvoClip 的运行环境、依赖安装、基础服务配置、配置文件参数、密钥管理和部署建议。

适用场景：

- 本地开发环境
- 测试环境
- 小规模生产验证环境

## 2. 环境总览

EvoClip 运行依赖如下组件：

- 应用层：Python、Node.js
- 媒体处理：FFmpeg / FFprobe
- 数据与缓存：PostgreSQL、Redis
- 对象存储：MinIO
- 模型能力：DashScope、OpenAI（或可替代提供方）

## 3. 推荐软硬件规格

### 3.1 最低配置（开发）

- CPU：4 核
- 内存：8 GB
- 磁盘：50 GB（建议 SSD）
- 系统：Ubuntu 22.04 / macOS / WSL2

### 3.2 推荐配置（测试/预发布）

- CPU：8 核
- 内存：16 GB+
- 磁盘：100 GB+
- 网络：可访问外部模型 API

## 4. 系统依赖安装

以下示例基于 Ubuntu 22.04。

```bash
sudo apt update
sudo apt install -y \
  python3 python3-venv python3-pip \
  nodejs npm \
  ffmpeg \
  redis-server \
  postgresql postgresql-contrib
```

安装完成后验证：

```bash
python3 --version
node --version
ffmpeg -version
redis-server --version
psql --version
```

## 5. Python 与 Node 依赖安装

### 5.1 Python

```bash
python3 -m venv .venv
source .venv/bin/activate
pip install -U pip
pip install -e .[dev]
```

### 5.2 Node（前端）

```bash
cd web
npm install
cd ..
```

### 5.3 使用模板配置并隔离私密信息（推荐）

```bash
cp config/config.template.yaml config/config.local.yaml
export EVOCLIP_CONFIG_PATH=config/config.local.yaml
```

说明：

- `config/config.template.yaml`：仓库模板文件，可提交 GitHub。
- `config/config.local.yaml`：本地私有配置文件，存放真实密钥，不应提交。
- 系统会优先读取环境变量 `EVOCLIP_CONFIG_PATH` 指向的配置文件。

## 6. PostgreSQL 配置

### 6.1 创建数据库和用户

```bash
sudo -u postgres psql
```

在 psql 中执行：

```sql
CREATE DATABASE evoclip;
CREATE USER evoclip_user WITH ENCRYPTED PASSWORD 'change_me';
GRANT ALL PRIVILEGES ON DATABASE evoclip TO evoclip_user;
```

### 6.2 修改配置文件连接串

编辑 `config/config.local.yaml`：

```yaml
postgres:
  dsn: postgresql+asyncpg://evoclip_user:change_me@localhost:5432/evoclip
```

### 6.3 初始化表结构

```bash
source .venv/bin/activate
python3 scripts/init_db.py
```

## 7. Redis 配置

### 7.1 启动 Redis

```bash
sudo systemctl enable redis-server
sudo systemctl start redis-server
```

### 7.2 配置连接地址

编辑 `config/config.local.yaml`：

```yaml
redis:
  url: redis://localhost:6379/0
```

### 7.3 初始化 Redis 键

```bash
source .venv/bin/activate
python3 scripts/init_redis.py
```

## 8. MinIO 配置

### 8.1 Docker 启动示例

```bash
docker run -d --name evoclip-minio \
  -p 9000:9000 -p 9001:9001 \
  -e MINIO_ROOT_USER=minioadmin \
  -e MINIO_ROOT_PASSWORD=minioadmin \
  -v $PWD/.minio-data:/data \
  minio/minio server /data --console-address ":9001"
```

### 8.2 配置 MinIO 连接

编辑 `config/config.local.yaml`：

```yaml
storage:
  minio:
    endpoint: localhost:9000
    access_key: minioadmin
    secret_key: minioadmin
    secure: false
    buckets:
      videos: videos
      audio: audio
      intermediate: intermediate
      output: output
```

### 8.3 初始化 Bucket

```bash
source .venv/bin/activate
python3 scripts/init_storage.py
```

## 9. 模型 API 与密钥配置

EvoClip 涉及多个模型服务，开发环境可直接写入配置文件。

### 9.1 必需密钥（写入配置文件）

编辑 `config/config.local.yaml`：

```yaml
credentials:
  # 阿里云百炼：视觉分析与语音识别
  dashscope_api_key: "your-dashscope-key"
  dashscope_base_url: "https://dashscope.aliyuncs.com/api/v1"

  # 聊天类模型：LongCat-Flash-Chat
  llm_api_key: "your-longcat-key"
  llm_base_url: "https://api.longcat.chat/openai/v1"

  # Embedding：使用 OpenAI 兼容接口时配置
  embedding_api_key: "your-dashscope-key"
  embedding_base_url: "https://dashscope.aliyuncs.com/compatible-mode/v1"

  # 如使用 OpenAI TTS 再填写
  openai_api_key: ""
  openai_base_url: "https://api.openai.com/v1"
```

如果启用火山引擎 TTS，请补充其官方要求的凭证变量。
若 Embedding 使用 `qwen3-vl-embedding` 等多模态模型，将走百炼原生接口（读取 `dashscope_api_key`/`dashscope_base_url`），`embedding_base_url` 可保留但不会被使用。

推荐模型配置：

```yaml
vision:
  provider: dashscope
  model: qwen-vl-max-latest

llm:
  provider: openai
  model: LongCat-Flash-Chat

tts:
  provider: dashscope_clone
  dashscope_model: cosyvoice-v3-plus
  dashscope_voice: longanyang
  dashscope_voice_id: ""   # 有固定复刻音色可直接填写
  clone_from_video: true
  clone_sample_seconds: 15
  clone_sample_max_seconds: 60
  clone_language_hint: "zh"
  clone_public_base_url: "https://your-public-minio-domain"
```

说明：百炼声音复刻要求可公网访问的音频 URL。若本地 MinIO 是 `localhost`，请配置 `tts.clone_public_base_url` 或直接填写 `tts.clone_audio_url`。
如需使用多段视频作为音色参考，可在创建任务时上传多段参考视频，系统会按 `clone_sample_seconds` 的总时长进行拼接并发起复刻。

### 9.2 配置文件中的模型选择

`config/config.local.yaml` 中可切换：

- `vision.provider/model`
- `speech_recognition.provider/model`
- `tts.provider`
- `llm.provider/model`
- `embedding.provider/model`

## 10. 核心配置项详解（config/config.local.yaml）

### 10.1 应用级配置（`app`）

- `task_queue_prefix`：Redis 任务队列键前缀
- `session_ttl_seconds`：任务会话元数据过期时间
- `progress_ttl_seconds`：进度缓存过期时间
- `sse_channel_prefix`：SSE 频道前缀

### 10.2 外部服务重试与超时

- `vision.timeout_seconds/max_retries`
- `speech_recognition.timeout_seconds/max_retries`
- `tts.timeout_seconds/max_retries`
- `llm.timeout_seconds/max_retries`

这些参数影响系统在网络抖动或 API 限流时的稳定性。

### 10.3 路径配置（`paths`）

- `prohibited_words`：违禁词文件路径
- `copy_prompt`：文案生成 Prompt 模板路径
- `optimization_prompt`：优化建议 Prompt 模板路径

## 11. 进程启动与管理配置

`supervisord.conf` 定义了主进程与各 Skill 的启动顺序和自动重启策略。

关键建议：

- 统一输出到 `logs/` 目录
- 设置 `autostart=true` 与 `autorestart=true`
- 使用不同 `priority` 管理启动顺序

启动命令：

```bash
mkdir -p logs
supervisord -c supervisord.conf
```

## 12. 前端环境配置

### 12.1 开发启动

```bash
cd web
npm run dev
```

### 12.2 构建发布

```bash
cd web
npm run build
```

后端 `api/main.py` 会在 `web/dist` 存在时挂载静态站点。

### 12.3 Nginx 反向代理

可参考 `web/nginx.conf`：

- `/api/` 转发到 FastAPI
- 前端路由使用 `try_files` 回退到 `index.html`

## 13. 安全配置建议

- 立即替换 MinIO 默认账号密码
- PostgreSQL 使用最小权限账户
- Redis 生产环境启用访问控制（密码/ACL）
- API Key 不要提交到仓库，可使用本地配置文件或 Secret 管理
- 对外暴露服务必须启用 HTTPS

## 14. 验收检查清单

启动前检查：

- [ ] `config/config.yaml` 的连接地址与账号密码正确
- [ ] `config/config.yaml` 中 `credentials` 已填写
- [ ] PostgreSQL、Redis、MinIO 服务可达
- [ ] `ffmpeg`/`ffprobe` 命令可用

启动后检查：

- [ ] `POST /tasks` 可创建任务
- [ ] `GET /tasks/{id}` 可返回进度
- [ ] `GET /tasks/{id}/events` 可收到 SSE
- [ ] `GET /tasks/{id}/download` 可下载结果视频

## 15. 常见配置错误

### 15.1 DSN 格式错误

现象：数据库连接报错。

处理：确认 `postgres.dsn` 使用 `postgresql+asyncpg://` 协议头。

### 15.2 MinIO endpoint 不可达

现象：上传/下载对象失败。

处理：确认 `endpoint` 与 `secure` 参数匹配实际部署（HTTP/HTTPS）。

### 15.3 API Key 缺失

现象：文案/语音/视觉分析调用失败。

处理：确认 `config/config.yaml` 中 `credentials` 已填写，并重启相关进程。

### 15.4 前端可打开但无数据

现象：页面正常但任务请求失败。

处理：检查前端代理、后端地址、CORS（如有跨域部署）。

## 16. 环境分层建议

建议至少区分三套配置：

- `dev`：开发环境，便于快速调试
- `test`：联调环境，验证接口和流程
- `prod`：生产环境，严格权限和审计

可通过维护多份配置文件（如 `config/config.dev.yaml`、`config/config.test.yaml`、`config/config.prod.yaml`）实现分层。
