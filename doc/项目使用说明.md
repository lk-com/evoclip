# EvoClip 项目使用说明

## 1. 文档目的

本文档面向开发、测试和运维人员，说明如何在本地或测试环境中使用 EvoClip 完成视频生成流程。

EvoClip 是一个基于 Agent + MCP + Skill 的视频生产系统，核心能力包括：

- `video-analysis`：视频关键帧与语音内容分析
- `copy-generation`：根据素材场景和商品信息生成文案
- `voice-synthesis`：将文案转为语音音频片段
- `video-render`：视频裁剪、合轨与拼接
- `quality-evaluation`：质量评估（同步/画面/违禁词）
- `skill-optimization`：基于诊断结果进行优化建议与应用

## 2. 项目目录说明

```text
agent/                      主编排 Agent
api/                        FastAPI 接口网关
skills/                     各 MCP Skill Server
store/                      PostgreSQL/Redis/MinIO 数据访问
config/                     业务配置、Prompt、词库
scripts/                    初始化与辅助脚本
tests/                      单元测试、接口测试、E2E 测试
web/                        Vue 3 前端
supervisord.conf            多进程启动配置
pyproject.toml              Python 依赖定义
```

## 3. 使用前准备

请先完成环境安装（见 `doc/环境配置说明.md`）。

最低要求：

- Python 3.11+
- Node.js 20+
- FFmpeg / FFprobe
- PostgreSQL 15+
- Redis 7+
- MinIO

## 4. 初始化步骤

### 4.1 安装后端依赖

```bash
python3 -m venv .venv
source .venv/bin/activate
pip install -e .[dev]
```

### 4.2 安装前端依赖

```bash
cd web
npm install
cd ..
```

### 4.3 配置文件检查

编辑 `config/config.yaml`，确认以下关键项与实际环境一致：

- PostgreSQL DSN：`postgres.dsn`
- Redis 地址：`redis.url`
- MinIO 连接：`storage.minio.endpoint/access_key/secret_key`
- 模型配置：`vision`、`speech_recognition`、`llm`、`tts`、`embedding`

### 4.4 初始化基础资源

```bash
python3 scripts/init_db.py
python3 scripts/init_storage.py
python3 scripts/init_redis.py
```

执行结果预期：

- PostgreSQL 已创建 `tasks`、`skill_versions` 表
- MinIO 已创建 `videos`、`audio`、`intermediate`、`output` Bucket
- Redis 初始化键值完成

## 5. 启动方式

### 5.1 方式一：supervisord（推荐）

```bash
mkdir -p logs
supervisord -c supervisord.conf
```

该方式将启动：

- `main-agent`
- `video-analysis`
- `copy-generation`
- `voice-synthesis`
- `video-render`
- `quality-evaluation`
- `skill-optimization`

### 5.2 方式二：手动启动（调试）

终端 1（Agent）：

```bash
source .venv/bin/activate
python3 -m agent.main_agent
```

终端 2（API）：

```bash
source .venv/bin/activate
uvicorn api.main:app --reload --host 0.0.0.0 --port 8000
```

终端 3（前端）：

```bash
cd web
npm run dev
```

## 6. API 使用说明

服务地址默认：`http://127.0.0.1:8000`

### 6.1 创建任务

- 接口：`POST /tasks`
- 入参：
  - `videos`：素材视频文件列表（MP4/MOV，支持多文件）
  - `video`：单素材视频文件（兼容旧调用方式）
  - `product_description`：商品描述文本
- 返回：`{ "task_id": "..." }`

示例：

```bash
curl -X POST "http://127.0.0.1:8000/tasks" \
  -F "videos=@tests/fixtures/sample_30s.mp4" \
  -F "videos=@tests/fixtures/sample_30s.mp4" \
  -F "product_description=智能保温杯，轻量便携，保温 6 小时"
```

### 6.2 查询任务

- 接口：`GET /tasks/{task_id}`
- 返回：任务状态、进度、输出文件键等信息

示例：

```bash
curl "http://127.0.0.1:8000/tasks/<task_id>"
```

### 6.3 订阅任务进度（SSE）

- 接口：`GET /tasks/{task_id}/events`
- 说明：实时推送各 Skill 状态与进度

示例：

```bash
curl -N "http://127.0.0.1:8000/tasks/<task_id>/events"
```

### 6.4 下载成品视频

- 接口：`GET /tasks/{task_id}/download`
- 返回：`video/mp4` 文件流

示例：

```bash
curl -L "http://127.0.0.1:8000/tasks/<task_id>/download" -o result.mp4
```

## 7. 前端使用流程

访问前端页面后，标准流程如下：

1. 在首页输入商品描述
2. 上传视频素材
3. 跳转任务详情页查看进度
4. 任务完成后预览视频并下载

对应页面：

- 首页：`/`
- 任务详情：`/task/:id`

## 8. 测试说明

### 8.1 单元测试/接口测试

```bash
source .venv/bin/activate
pytest
```

### 8.2 生成 E2E 测试视频素材

```bash
./scripts/generate_fixture_video.sh
```

### 8.3 执行 E2E 测试

```bash
EVOCLIP_E2E=1 ./scripts/run_e2e.sh
```

说明：E2E 测试依赖完整运行环境（API + Agent + PostgreSQL + Redis + MinIO + 外部模型服务可用）。

## 9. 常见问题与排查

### 9.1 `No module named pytest`

未安装开发依赖，请执行：

```bash
pip install -e .[dev]
```

### 9.2 MinIO 连接失败

排查项：

- `config/config.yaml` 中 endpoint、账号密码是否正确
- MinIO 服务是否已启动
- 网络端口是否可达

### 9.3 创建任务后长期无进度

排查项：

- Agent 进程是否运行
- Redis 队列是否有消费
- `logs/` 下 `main-agent` 与各 skill 日志是否报错

### 9.4 视频渲染失败

排查项：

- 系统是否安装 `ffmpeg` / `ffprobe`
- 输入视频格式是否受支持（MP4/MOV）
- 磁盘空间是否足够

### 9.5 外部模型 API 调用失败

排查项：

- API Key 是否配置
- 模型名是否与供应商一致
- 超时与重试参数是否需要调整（`config/config.yaml`）

## 10. 生产使用建议

- 使用独立数据库和对象存储账号，避免共用默认口令
- 通过反向代理（Nginx）统一入口并启用 HTTPS
- 任务与日志做定期归档
- 对 API 做访问控制与限流
- 关键配置和密钥通过环境变量或密钥管理系统注入

## 11. 版本与变更建议

建议将配置、Prompt、词典与代码统一版本化管理，并建立以下流程：

1. 变更前备份配置
2. 小流量验证
3. 指标观察（任务成功率、平均时长、失败原因）
4. 再逐步扩大范围
